# Example Nginx configuration for www.example.com MediaWiki instance
server {
    listen 80;
    listen [::]:80;
    server_name www.example.com example.com;

    # Redirect root to the wiki homepage
    location = / {
        return 301 https://www.example.com/wiki/Startseite;
    }

    # Redirect everything else to HTTPS on the canonical host
    return 301 https://www.example.com$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name laub-home.de;

    # Use a SAN certificate that actually includes ALL the above names
    ssl_certificate /etc/letsencrypt/live/lhlab.wiki/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lhlab.wiki/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/lhlab.wiki/chain.pem;

    include /etc/nginx/conf.d/includes/ssl.conf;

    # Always move to apex (canonical host)
    return 301 https://www.example.com$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name www.example.com;
    location = / {
        return 301 https://www.example.com/wiki/Willkommen_im_LHlab;
    }

    ssl_certificate /etc/letsencrypt/live/lhlab.wiki/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lhlab.wiki/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/lhlab.wiki/chain.pem;

    access_log /var/log/nginx/access_all.log goaccess_logging;

    include /etc/nginx/conf.d/includes/ssl.conf;
    include /etc/nginx/conf.d/includes/site-defaults.conf;
    include /etc/nginx/conf.d/includes/certbot.conf;
    include /etc/nginx/conf.d/includes/security-headers.conf;
    include /etc/nginx/conf.d/includes/csp.conf;
    expires $expires;
    client_max_body_size 110m;

    # Basic Auth für das Testsystem
    # auth_basic           "Restricted Area";
    # auth_basic_user_file /etc/nginx/conf.d/.htpasswd;

    location / {
        # Proxy basics
        proxy_set_header Host               $host;
        proxy_set_header X-Forwarded-For    $remote_addr;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_pass http://website_prod;

        # Cache settings (honor upstream Cache-Control from MediaWiki)
        proxy_cache           mwcache;
        proxy_cache_key       "$scheme$host$request_uri|mf=$mf_useformat";

        # Bypass/Don't-store conditions
        proxy_cache_bypass  $mw_cache_bypass $mw_bypass_method $mw_bypass_action $mw_bypass_nocache;
        proxy_no_cache      $mw_cache_bypass $mw_bypass_method $mw_bypass_action $mw_bypass_nocache;

        # Serve stale on errors / while updating (nice for spikes/deploys)
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;

        # Hide conflicting headers from upstream
        proxy_hide_header X-Content-Type-Options;
        proxy_hide_header X-Frame-Options;
    }

    # --- Never cache the API ---
    location ~* ^/(w/)?api\.php$ {
        proxy_set_header Host              $host;
        proxy_set_header X-Forwarded-For   $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://website_prod;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    # --- Do not cache Special: pages (dynamic) ---
    location ~ ^/wiki/(Special|Spezial): {
        proxy_set_header Host              $host;
        proxy_set_header X-Forwarded-For   $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://website_prod;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    location ~* ^/images/.*\.svg$ {
        proxy_pass http://website_prod;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 8 32k;
        expires off;
        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=2592000, immutable";

        include /etc/nginx/conf.d/includes/security-headers.conf;
        include /etc/nginx/conf.d/includes/csp.conf;
    }

    location ~* ^/images/(?:thumb/)?(.+\.(?:jpe?g|png|gif|webp|avif))$ {
        # Source: directly MediaWiki (container name via Docker DNS)
        set $src "http://127.0.0.1:8080$uri$is_args$args";

        # Pass on header
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Tight timeouts so that fallback kicks in
        proxy_connect_timeout 300ms;
        proxy_send_timeout    1s;
        proxy_read_timeout    1s;

        # Cache (recommended)
        proxy_cache         img_cache;
        proxy_cache_bypass  $mw_cache_bypass $mw_bypass_method $mw_bypass_action $mw_bypass_nocache;
        proxy_no_cache      $mw_cache_bypass $mw_bypass_method $mw_bypass_action $mw_bypass_nocache;
        # Format belongs in the cache key, otherwise variants will be mixed up.
        proxy_cache_key    "$scheme$proxy_host$request_uri|$imgfmt";
        proxy_cache_lock    on;
        proxy_cache_valid   200 301 302 30d;
        proxy_cache_use_stale error timeout invalid_header http_500 http_502 http_503 http_504 updating;

        # Uniform vary header
        proxy_hide_header Vary;
        add_header Vary Accept always;

        # Enable fallback
        proxy_intercept_errors on;
        error_page 500 502 503 504 408 = @wiki_direct;
        # Optionally, also switch to imgproxy for 404 errors:
        # error_page 404 = @wiki_direct;

        # Transfer to imgproxy – target format from $imgfmt
        proxy_pass http://imgproxy_backend/insecure/plain/$src@$imgfmt;

        # Buffer
        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 8 32k;

        # Browser-Caching
        expires off;
        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=2592000, immutable";
        include /etc/nginx/conf.d/includes/security-headers.conf;
        include /etc/nginx/conf.d/includes/csp.conf;
    }

    # --- Fallback: directly from MediaWiki without re-encoding ---
    location @wiki_direct {
        add_header X-Imgproxy-Fallback "1" always;

        proxy_pass http://website_prod;   # Query & URI werden automatisch mitgenommen
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache off;  # optional: Fallback nicht im Proxy cachen

        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        add_header Vary Accept always;
        include /etc/nginx/conf.d/includes/security-headers.conf;
        include /etc/nginx/conf.d/includes/csp.conf;
    }

    location = /csp-report {
        # Simple example: log reports and return 204
        access_log /var/log/nginx/csp_reports.log;
        return 204;
    }

}
